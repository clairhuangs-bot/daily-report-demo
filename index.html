<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataInsight v4.52 PRO - 遊戲數據決策系統 (重大事件優化版)</title>
    
    <!-- 1. 核心樣式與字體 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- 2. 核心庫 (順序優化以解決 Recharts 報錯) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 視覺優化：柔和底色，減少螢幕刺激 */
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9; 
            margin: 0; 
            padding: 0; 
            color: #334155;
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out both; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .expand-content { transition: max-height 0.5s ease, opacity 0.3s ease; overflow: hidden; }
        
        /* 任務指令 1：動態圖示特效 (呼吸燈) */
        @keyframes breathing-alert {
            0% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(225, 29, 72, 0)); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 10px rgba(225, 29, 72, 0.5)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(225, 29, 72, 0)); }
        }
        .animate-breathing { animation: breathing-alert 2s infinite ease-in-out; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top: 4px solid #4f46e5; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .premium-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        .clickable-date { cursor: pointer; transition: all 0.2s; }
        .clickable-date:hover { background-color: #e2e8f0 !important; color: #4f46e5 !important; }
        .active-date-column { background-color: #eff6ff !important; border-radius: 8px; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="antialiased">
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: 800; color: #64748b; font-size: 14px;">正在校準重大事件連動數據...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, 
            ResponsiveContainer, PieChart, Pie, Cell, LineChart, Line, AreaChart, Area 
        } = window.Recharts;

        // --- 核心專案配置 ---
        const ONLINE_ORDER = ['明星3缺1', '滿貫大亨', '捕魚大玩咖', '唯舞獨尊', '競技麻將2', '儲值專線', 'Vegas Frenzy', '大滿貫', '玩星派對', '幸運拉霸GO'];
        const COMMERCIAL_ORDER = ['金猴爺', '金虎爺', '金好運娛樂城', '金好運娛樂城MY (TH,SG)', '金好運娛樂城JP', '海王寶藏', '撞球好手', '三國戰紀', 'Slotverse', '跑跑英雄'];

        const GAME_ISSUE_CONFIG = {
            '明星3缺1': ["帳號問題", "伺服器相關問題", "儲值相關問題", "安裝、下載", "系統相關問題", "活動領獎問題", "規則設定問題", "反應與建議", "客戶服務", "行動版問題"],
            '唯舞獨尊': ["帳號問題", "伺服器相關問題", "儲值相關問題", "系統相關問題", "活動領獎問題", "規則設定問題", "活動相關問題", "反應與建議", "產品問題", "其他問題", "行動版問題"],
            '儲值專線': ["會員/認證類", "儲值卡", "信用卡", "Web ATM", "Smart Pay", "市內電話", "固網", "行動電話", "手機簡碼", "手機語音"],
            'Default': ["帳號問題", "伺服器問題", "安裝問題", "儲值問題", "活動問題", "遊戲問題", "建議反饋", "其他"]
        };

        const COLORS = ['#6366f1', '#0ea5e9', '#f59e0b', '#ec4899', '#8b5cf6', '#10b981', '#f43f5e', '#64748b', '#06b6d4', '#4f46e5'];

        // --- 工具組件 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const StatCard = ({ title, value, prevValue, iconName, gradient }) => {
            const diff = value - (prevValue || 0);
            const percent = (prevValue && prevValue !== 0) ? ((diff / prevValue) * 100).toFixed(1) : 0;
            return (
                <div className="relative p-6 rounded-[2rem] bg-white border border-slate-100 premium-shadow overflow-hidden group hover:-translate-y-1 transition-all duration-300">
                    <div className="flex items-center justify-between mb-4">
                        <p className="text-slate-400 text-[10px] font-black uppercase tracking-widest">{title}</p>
                        <div className={`p-2.5 rounded-xl ${gradient} text-white shadow-lg`}><Icon name={iconName} size={18} /></div>
                    </div>
                    <div className="flex items-end gap-2">
                        <h3 className="text-3xl font-black text-slate-800 tracking-tighter tabular-nums">{value.toLocaleString()}</h3>
                        {percent !== 0 && (
                            <div className={`flex items-center gap-0.5 text-[10px] font-black px-1.5 py-0.5 rounded-lg mb-1 ${diff >= 0 ? 'bg-rose-50 text-rose-600' : 'bg-emerald-50 text-emerald-600'}`}>
                                {diff >= 0 ? "▲" : "▼"} {Math.abs(percent)}%
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const IncidentItem = ({ incident }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isCritical = incident.severity === 'critical';
            return (
                <div className={`mb-3 rounded-2xl transition-all duration-300 ring-1 ${isExpanded ? 'bg-white shadow-lg ring-slate-200 py-1' : 'bg-slate-50/50 ring-slate-100'}`}>
                    <div className="px-5 py-4 flex justify-between items-center cursor-pointer select-none" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex items-center gap-3">
                            <div className={`p-2 rounded-lg ${isCritical ? 'bg-rose-100 text-rose-600' : 'bg-amber-100 text-amber-600'}`}><Icon name="alert-circle" size={16} /></div>
                            <span className={`font-black text-sm ${isCritical ? 'text-rose-900' : 'text-slate-800'}`}>{incident.summary}</span>
                        </div>
                        <Icon name={isExpanded ? "chevron-up" : "chevron-down"} size={16} className="text-slate-400" />
                    </div>
                    {isExpanded && (
                        <div className="px-5 pb-4 text-xs text-slate-600 leading-relaxed border-t border-slate-100 pt-3 bg-white rounded-b-2xl">
                            {incident.description}
                            <div className="mt-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">{incident.time} 系統紀錄</div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 核心優化：重大事件模組 (Major Events Module) ---
        const MajorEventsModule = ({ currentReport }) => {
            // 任務指令 3：即時關鍵字搜尋狀態
            const [searchTerm, setSearchTerm] = useState('');
            
            // 基礎資料邏輯
            const rawIncidents = currentReport?.majorIncidents || [];
            
            // 任務指令 1：偵測事件長度
            const hasEvents = rawIncidents.length > 0;

            // 任務指令 3：關鍵字搜尋邏輯 (過濾標題與內容)
            const filteredIncidents = useMemo(() => {
                if (!searchTerm.trim()) return rawIncidents;
                const term = searchTerm.toLowerCase();
                return rawIncidents.filter(inc => 
                    inc.summary.toLowerCase().includes(term) || 
                    inc.description.toLowerCase().includes(term)
                );
            }, [rawIncidents, searchTerm]);

            return (
                <div className="xl:col-span-1 bg-white p-10 rounded-[3.5rem] border border-slate-200 premium-shadow min-h-[600px] flex flex-col transition-all duration-500">
                    
                    {/* 標題與動態圖示特效 (指令 1) */}
                    <div className="flex items-center justify-between mb-8">
                        <div className="flex items-center gap-4">
                            <div className="relative">
                                <Icon 
                                    name="alert-triangle" 
                                    size={36} 
                                    className={`text-rose-600 ${hasEvents ? 'animate-breathing' : 'opacity-20'}`} 
                                />
                                {hasEvents && (
                                    <span className="absolute top-0 right-0 flex h-3 w-3">
                                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
                                        <span className="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span>
                                    </span>
                                )}
                            </div>
                            <h3 className="font-black text-slate-900 text-3xl tracking-tighter">本日重大異常</h3>
                        </div>
                    </div>

                    {/* 任務指令 3：即時關鍵字搜尋框 (僅在有事件或搜尋時顯示) */}
                    {(hasEvents || searchTerm) && (
                        <div className="relative mb-6 animate-fade-in">
                            <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                <Icon name="search" size={16} className="text-slate-400" />
                            </div>
                            <input
                                type="search"
                                placeholder="搜尋標題或描述內容..."
                                className="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none focus:ring-4 focus:ring-indigo-500/10 focus:bg-white transition-all shadow-inner"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                    )}

                    {/* 列表與任務指令 2：空狀態處理 (Empty State) */}
                    <div className="space-y-3 flex-grow overflow-y-auto pr-1">
                        {filteredIncidents.length > 0 ? (
                            filteredIncidents.map((inc) => <IncidentItem key={inc.id} incident={inc} />)
                        ) : (
                            <div className="flex flex-col items-center justify-center py-32 text-slate-300 gap-5 opacity-60 animate-fade-in">
                                <div className="bg-slate-100 p-6 rounded-full">
                                    <Icon name={searchTerm ? "search-x" : "check-circle"} size={64} className="text-slate-200" />
                                </div>
                                <div className="text-center">
                                    <p className="font-black italic tracking-widest text-lg">
                                        {searchTerm ? '查無匹配的異常紀錄' : '本日無重大事件'}
                                    </p>
                                    <p className="text-[10px] font-bold uppercase mt-2 tracking-[0.2em] text-slate-400">
                                        {searchTerm ? '請嘗試其他關鍵字' : 'System Healthy & Stable'}
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 專案分析列 ---
        const ProjectAnalysisRow = ({ name, trendData, timeScale, currentSelectedDate, onDateClick, activeTab }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            if (!trendData) return null;
            const issueCategories = useMemo(() => GAME_ISSUE_CONFIG[name] || GAME_ISSUE_CONFIG['Default'], [name]);
            const totalInView = trendData.reduce((s, a) => s + (a.count || 0), 0);
            
            return (
                <div className={`rounded-[2.5rem] transition-all duration-500 border border-transparent mb-4 ${isExpanded ? 'bg-white shadow-xl ring-1 ring-indigo-100' : 'bg-white border-slate-200 hover:border-indigo-300'} premium-shadow`}>
                    <div className="px-8 py-6 flex items-center justify-between cursor-pointer select-none" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex items-center gap-6 w-72 shrink-0">
                            <div className={`p-3.5 rounded-2xl transition-all shadow-md ${isExpanded ? 'bg-indigo-600 text-white' : 'bg-slate-50 text-slate-400'}`}>
                                <Icon name="chevron-right" size={24} className={isExpanded ? "rotate-90" : ""} />
                            </div>
                            <span className="font-black text-slate-800 text-xl tracking-tight block">{name}</span>
                        </div>
                        <div className="flex-grow h-14 max-w-xl mx-10 opacity-60">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart data={trendData}><Area type="monotone" dataKey="count" stroke="#4f46e5" fill="#e0e7ff" strokeWidth={2} dot={false} /></AreaChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="text-right w-48 border-l border-slate-100 pl-8">
                           <p className="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">{timeScale === 'weekly' ? '週期' : '日'}總計</p>
                           <p className={`text-3xl font-black tabular-nums ${isExpanded ? 'text-indigo-600' : 'text-slate-800'}`}>{totalInView.toLocaleString()}</p>
                        </div>
                    </div>
                    {isExpanded && (
                        <div className="px-10 pb-10 animate-fade-in border-t border-slate-50 pt-8">
                            <div className="grid grid-cols-1 gap-8">
                                <div className="bg-slate-50/80 p-8 rounded-[2.5rem] border border-slate-200">
                                    <h4 className="text-sm font-black text-slate-900 flex items-center gap-3 mb-8"><Icon name="activity" size={20} className="text-indigo-600" /> 問題類型趨勢分析</h4>
                                    <div className="h-[380px] w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={trendData}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 700}} />
                                                <YAxis axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 700}} />
                                                <Tooltip contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)' }} />
                                                {issueCategories.map((type, i) => <Area key={type} type="monotone" dataKey={type} stackId="1" stroke={COLORS[i % COLORS.length]} fill={COLORS[i % COLORS.length]} fillOpacity={0.75} />)}
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                                <div className="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead><tr className="text-slate-400 font-black text-[10px] uppercase">
                                            <th className="pl-8 py-5 min-w-[150px] bg-slate-50/50">項目 \ 日期</th>
                                            {trendData.map(d => <th key={d.name} onClick={() => timeScale === 'daily' && onDateClick(d.fullDate)} className={`text-center py-5 bg-slate-50/50 ${timeScale === 'daily' ? 'clickable-date hover:text-indigo-600' : ''} ${currentSelectedDate === d.fullDate ? 'text-indigo-600 active-date-column' : ''}`}>{d.name}</th>)}
                                            <th className="text-right pr-8 py-5 bg-slate-50/50">合計</th>
                                        </tr></thead>
                                        <tbody>
                                            {issueCategories.map(cat => (
                                                <tr key={cat} className="hover:bg-slate-50/50 border-b border-slate-50">
                                                    <td className="font-bold text-slate-600 pl-8 py-4 text-xs">{cat}</td>
                                                    {trendData.map(d => <td key={d.name} className={`text-center text-xs font-bold text-slate-500 ${currentSelectedDate === d.fullDate ? 'active-date-column' : ''}`}>{(d[cat] || 0).toLocaleString()}</td>)}
                                                    <td className="text-right pr-8 font-black text-indigo-500 text-xs">{(trendData.reduce((s, a) => s + (a[cat] || 0), 0)).toLocaleString()}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 主應用 ---
        function App() {
            const [activeTab, setActiveTab] = useState('general'); 
            const [timeScale, setTimeScale] = useState('daily');
            const [selectedDate, setSelectedDate] = useState('');
            const [database, setDatabase] = useState({});

            useEffect(() => {
                const db = {};
                const startDate = new Date('2026-01-01'); 
                for (let i = 0; i < 60; i++) {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate() + i);
                    const dateStr = d.toISOString().split('T')[0];
                    
                    const makeMockStats = (base) => ({
                        tickets: base + Math.floor(Math.random()*100), phoneCalls: 60, emails: 280, alertMails: 20, redmineReplies: 120
                    });

                    const onlineIncidents = [];
                    const commercialIncidents = [];
                    if (dateStr === '2026-02-07') {
                        onlineIncidents.push({ id: "o1", severity: "critical", summary: "明星3缺1 iOS 支付驗證逾時", description: "iOS 金流憑證更換交握延遲，影響玩家儲值入點大約 30 分鐘。", time: "14:30" });
                        onlineIncidents.push({ id: "o2", severity: "warning", summary: "伺服器例行維護公告延遲", description: "官網公告系統快取問題，導致部分玩家未能即時收到維護通知。", time: "10:15" });
                    }
                    if (dateStr === '2026-02-06') {
                        onlineIncidents.push({ id: "o3", severity: "warning", summary: "連假活動登入排隊壅塞", description: "週末慶典活動開啟導致瞬時流量峰值，玩家平均排隊約 3 分鐘。", time: "19:00" });
                    }
                    if (dateStr === '2026-02-05') {
                        commercialIncidents.push({ id: "c1", severity: "critical", summary: "商用驗證 API 響應延遲", description: "KYC 驗證系統負載過高，部分新用戶無法順利完成身分認證程序。", time: "10:15" });
                    }

                    db[dateStr] = {
                        general: { stats: makeMockStats(500), majorIncidents: onlineIncidents, gameStats: {} },
                        commercial: { stats: makeMockStats(300), majorIncidents: commercialIncidents, gameStats: {} }
                    };

                    [...ONLINE_ORDER, ...COMMERCIAL_ORDER].forEach(g => {
                        const cats = GAME_ISSUE_CONFIG[g] || GAME_ISSUE_CONFIG['Default'];
                        const data = { count: 0 };
                        cats.forEach(c => { const v = 3 + Math.floor(Math.random()*15); data[c] = v; data.count += v; });
                        if (ONLINE_ORDER.includes(g)) db[dateStr].general.gameStats[g] = data;
                        else db[dateStr].commercial.gameStats[g] = data;
                    });
                }
                setDatabase(db);
                setSelectedDate(Object.keys(db).sort().reverse()[0]);
                setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; }, 1000);
            }, []);

            const datesList = useMemo(() => Object.keys(database).sort().reverse(), [database]);
            const currentReport = database[selectedDate]?.[activeTab] || null;
            const prevReport = useMemo(() => {
                const idx = datesList.indexOf(selectedDate);
                return idx < datesList.length - 1 ? database[datesList[idx+1]]?.[activeTab] : null;
            }, [database, selectedDate, activeTab, datesList]);

            const chartData = useMemo(() => {
                if (!currentReport) return [];
                const list = activeTab === 'general' ? ONLINE_ORDER : COMMERCIAL_ORDER;
                const baseData = list.map(name => ({ name, count: currentReport.gameStats?.[name]?.count || 0 }));
                const total = baseData.reduce((s, a) => s + a.count, 1);
                return baseData.map(d => ({ ...d, percent: ((d.count / total) * 100).toFixed(1) })).sort((a,b) => b.count - a.count);
            }, [currentReport, activeTab]);

            const getProjectTrend = (projectName) => {
                const cats = GAME_ISSUE_CONFIG[projectName] || GAME_ISSUE_CONFIG['Default'];
                const startIndex = datesList.indexOf(selectedDate);
                if (startIndex === -1) return [];

                if (timeScale === 'weekly') {
                    const weeks = [];
                    for (let i = 0; i < 4; i++) {
                        const offset = startIndex + (i * 7);
                        const weekRange = datesList.slice(offset, offset + 7);
                        if (weekRange.length === 0) continue;
                        const weekData = { name: `W${4-i}`, count: 0, fullDate: weekRange[0] };
                        cats.forEach(c => weekData[c] = 0);
                        weekRange.forEach(dateKey => {
                            const report = database[dateKey]?.[activeTab];
                            const gameData = report?.gameStats?.[projectName] || {};
                            weekData.count += (gameData.count || 0);
                            cats.forEach(c => { weekData[c] += (gameData[c] || 0); });
                        });
                        weeks.push(weekData);
                    }
                    return weeks.reverse();
                } else {
                    const dates = datesList.slice(startIndex, startIndex + 7).reverse();
                    return dates.map(dateKey => ({ name: dateKey.slice(5), fullDate: dateKey, ...(database[dateKey]?.[activeTab]?.gameStats?.[projectName] || { count: 0 }) }));
                }
            };

            const renderPieLabel = ({ cx, cy, midAngle, innerRadius, outerRadius, percent, name, value }) => {
                const radius = innerRadius + (outerRadius - innerRadius) * 1.6;
                const x = cx + radius * Math.cos(-midAngle * (Math.PI / 180));
                const y = cy + radius * Math.sin(-midAngle * (Math.PI / 180));
                return <text x={x} y={y} fill="#64748b" textAnchor={x > cx ? 'start' : 'end'} dominantBaseline="central" fontSize="10" fontWeight="900">{`${name} ${value}件 (${(percent * 100).toFixed(0)}%)`}</text>;
            };

            return (
                <div className="min-h-screen pb-24 animate-fade-in">
                    <header className="sticky top-0 z-50 bg-white/90 backdrop-blur-xl border-b border-slate-200/80 h-20 flex items-center shadow-sm">
                        <div className="max-w-screen-2xl mx-auto px-8 w-full flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <div className="bg-slate-900 p-2.5 rounded-2xl shadow-lg rotate-2"><Icon name="shield-check" className="text-white" /></div>
                                <div><h1 className="font-black text-2xl tracking-tighter text-slate-900 leading-none">DataInsight <span className="bg-indigo-600 text-white text-[9px] px-2 py-0.5 rounded uppercase ml-2">v4.52 PRO</span></h1><p className="text-[9px] text-slate-400 font-black tracking-widest uppercase mt-1">決策級連動數據平台</p></div>
                            </div>
                            <div className="flex items-center gap-3 px-5 py-2.5 bg-slate-200/50 rounded-2xl border border-slate-300/50">
                                <Icon name="calendar" size={15} className="text-slate-500" />
                                <select value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="bg-transparent text-xs font-black text-slate-700 outline-none cursor-pointer">
                                    {datesList.slice(0, 30).map(d => <option key={d} value={d}>{d}</option>)}
                                </select>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-screen-2xl mx-auto px-8 mt-10">
                        <div className="flex gap-4 mb-12">
                            <button onClick={() => setActiveTab('general')} className={`flex-1 py-6 rounded-[2.5rem] font-black text-xs uppercase tracking-widest transition-all shadow-md active:scale-95 ${activeTab==='general'?'bg-indigo-600 text-white scale-[1.01]':'bg-white text-slate-400 border border-slate-200 hover:bg-slate-50'}`}>線上遊戲 Online</button>
                            <button onClick={() => setActiveTab('commercial')} className={`flex-1 py-6 rounded-[2.5rem] font-black text-xs uppercase tracking-widest transition-all shadow-md active:scale-95 ${activeTab==='commercial'?'bg-indigo-600 text-white scale-[1.01]':'bg-white text-slate-400 border border-slate-200 hover:bg-slate-50'}`}>商用遊戲 Tech</button>
                        </div>

                        {currentReport && (
                            <div className="animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-5 gap-6 mb-12">
                                    <StatCard title="問題回報" value={currentReport.stats.tickets} prevValue={prevReport?.stats.tickets} iconName="file-text" gradient="bg-indigo-600" />
                                    <StatCard title="電話進線" value={currentReport.stats.phoneCalls} prevValue={prevReport?.stats.phoneCalls} iconName="phone" gradient="bg-emerald-600" />
                                    <StatCard title="信箱回報" value={currentReport.stats.emails} prevValue={prevReport?.stats.emails} iconName="mail" gradient="bg-purple-600" />
                                    <StatCard title="警示信件" value={currentReport.stats.alertMails} prevValue={prevReport?.stats.alertMails} iconName="activity" gradient="bg-rose-600" />
                                    <StatCard title="Redmine回單" value={currentReport.stats.redmineReplies} prevValue={prevReport?.stats.redmineReplies} iconName="clipboard-check" gradient="bg-amber-600" />
                                </div>

                                <div className="grid grid-cols-1 xl:grid-cols-3 gap-10 mb-12 items-start">
                                    {/* 核心優化模組：重大事件 */}
                                    <MajorEventsModule currentReport={currentReport} />

                                    <div className="xl:col-span-2 bg-white p-10 rounded-[3.5rem] border border-slate-200 premium-shadow min-h-[600px] overflow-hidden">
                                        <h3 className="font-black text-slate-900 text-3xl tracking-tighter flex items-center gap-3 mb-12"><Icon name="layers" className="text-indigo-600" size={28}/> 遊戲問題排行與佔比 ({selectedDate})</h3>
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                            <div className="h-[420px]">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={chartData} layout="vertical" margin={{ left: 10, right: 100 }}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} stroke="#f1f5f9" />
                                                        <XAxis type="number" hide />
                                                        <YAxis dataKey="name" type="category" width={110} tick={{ fontSize: 11, fontWeight: 900, fill: '#64748b' }} axisLine={false} tickLine={false} />
                                                        <Bar dataKey="count" radius={[0, 10, 10, 0]} barSize={20} fill="#4f46e5" label={{ position: 'right', fill: '#1e293b', fontSize: 10, fontWeight: 900, offset: 12, formatter: (val) => `${val}件 (${chartData.find(d=>d.count===val)?.percent}%)` }}>
                                                            {chartData.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                                                        </Bar>
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            </div>
                                            <div className="h-[420px] flex flex-col items-center">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie data={chartData.filter(d=>d.count>0).map(d=>({name:d.name, value:d.count}))} cx="50%" cy="45%" labelLine={true} label={renderPieLabel} outerRadius={95} innerRadius={60} paddingAngle={4} dataKey="value">
                                                            {chartData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} stroke="#fff" strokeWidth={3} />)}
                                                        </Pie>
                                                        <Tooltip />
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-10 rounded-[4rem] border border-slate-200 premium-shadow mb-20 overflow-hidden">
                                    <div className="flex justify-between items-center mb-12">
                                        <div className="flex items-center gap-4"><div className="bg-indigo-600 p-3.5 rounded-[1.5rem] shadow-lg shadow-indigo-200"><Icon name="trending-up" className="text-white" size={26}/></div><h3 className="font-black text-slate-900 text-3xl tracking-tight">各專案問題數據分析 (動態連動)</h3></div>
                                        <div className="flex bg-slate-100 p-2 rounded-[1.5rem] shadow-inner">
                                            <button onClick={() => setTimeScale('daily')} className={`px-8 py-2.5 rounded-[1.2rem] text-xs font-black transition-all ${timeScale === 'daily' ? 'bg-white text-indigo-600 shadow-md ring-1 ring-slate-200' : 'text-slate-400'}`}>日維度</button>
                                            <button onClick={() => setTimeScale('weekly')} className={`px-8 py-2.5 rounded-[1.2rem] text-xs font-black transition-all ${timeScale === 'weekly' ? 'bg-white text-indigo-600 shadow-md ring-1 ring-slate-200' : 'text-slate-400'}`}>週維度</button>
                                        </div>
                                    </div>
                                    <div className="space-y-6">
                                        {(activeTab === 'general' ? ONLINE_ORDER : COMMERCIAL_ORDER).map(name => (
                                            <ProjectAnalysisRow key={name} name={name} timeScale={timeScale} trendData={getProjectTrend(name)} currentSelectedDate={selectedDate} onDateClick={(date) => { setSelectedDate(date); window.scrollTo({ top: 0, behavior: 'smooth' }); }} activeTab={activeTab} />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="mt-10 border-t border-slate-200 py-16 opacity-30 text-center">
                        <Icon name="shield-check" size={32} className="text-slate-400 mb-4 inline-block"/>
                        <p className="text-[10px] font-black tracking-[0.4em] uppercase text-slate-500">DataInsight Intelligence Matrix • v4.52 Premium Suite</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
