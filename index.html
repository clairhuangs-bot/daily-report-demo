/* 重大事件欄位 (Major Events Module) 優化邏輯 
  1. 動態圖示特效：偵測事件長度套用呼吸燈。
  2. 即時關鍵字搜尋：前端動態過濾列表。
  3. 空狀態處理：無資料時顯示優雅提示。
*/

// --- 1. CSS 動畫樣式 (請加入到 <style> 標籤中) ---
/*
  定義一個呼吸燈效果 (Breathing Light)，
  運用於當有重大事件時的警告圖示。
*/
const style = `
@keyframes breathing-alert {
  0% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(225, 29, 72, 0)); }
  50% { transform: scale(1.1); filter: drop-shadow(0 0 8px rgba(225, 29, 72, 0.5)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(225, 29, 72, 0)); }
}
.animate-breathing {
  animation: breathing-alert 2s infinite ease-in-out;
}
`;

// --- 2. JavaScript 邏輯與 React 結構 ---

function MajorEventsModule({ currentReport }) {
  // 搜尋關鍵字狀態
  const [searchTerm, setSearchTerm] = useState('');

  // 邏輯：即時關鍵字搜尋
  // 使用 useMemo 確保只有在搜尋詞或報告內容變動時才重新過濾，優化效能
  const filteredIncidents = useMemo(() => {
    if (!currentReport?.majorIncidents) return [];
    
    // 如果搜尋框為空，顯示全部事件
    if (!searchTerm.trim()) return currentReport.majorIncidents;

    const term = searchTerm.toLowerCase();
    return currentReport.majorIncidents.filter(incident => 
      incident.summary.toLowerCase().includes(term) || 
      incident.description.toLowerCase().includes(term)
    );
  }, [currentReport?.majorIncidents, searchTerm]);

  // 邏輯：偵測事件長度
  const hasEvents = currentReport?.majorIncidents?.length > 0;

  return (
    <div className="xl:col-span-1 bg-white p-10 rounded-[3.5rem] border border-slate-200 premium-shadow min-h-[600px] flex flex-col">
      
      {/* 標題與動態圖示特效 */}
      <div className="flex items-center gap-4 mb-8">
        <div className="relative">
          <AlertTriangle 
            className={`text-rose-600 ${hasEvents ? 'animate-breathing' : 'opacity-40'}`} 
            size={36} 
          />
          {/* 小紅點裝飾：若有事件則顯示 */}
          {hasEvents && (
            <span className="absolute top-0 right-0 flex h-3 w-3">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span>
            </span>
          )}
        </div>
        <h3 className="font-black text-slate-900 text-3xl tracking-tighter mb-0">本日重大異常</h3>
      </div>

      {/* 3. 即時關鍵字搜尋框 */}
      {hasEvents && (
        <div className="relative mb-6 animate-fade-in">
          <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
            <Search className="text-slate-400" size={16} />
          </div>
          <input
            type="search"
            placeholder="搜尋關鍵字 (標題或內容)..."
            className="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-100 rounded-2xl text-sm font-bold outline-none focus:ring-4 focus:ring-indigo-500/10 focus:bg-white transition-all"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
      )}

      {/* 列表與空狀態處理 (Empty State) */}
      <div className="space-y-4 flex-grow overflow-y-auto pr-1">
        {filteredIncidents.length > 0 ? (
          // 顯示過濾後的列表
          filteredIncidents.map((m, i) => (
            <div key={m.id || i} className="animate-fade-in" style={{ animationDelay: `${i * 0.1}s` }}>
              <IncidentItem incident={m} />
            </div>
          ))
        ) : (
          // 邏輯：空狀態處理 (無事件或搜尋無結果)
          <div className="flex flex-col items-center justify-center py-32 text-slate-300 gap-5 opacity-60">
            <div className="bg-slate-100 p-6 rounded-full">
              {searchTerm ? <Search size={48} /> : <CheckCircle size={48} />}
            </div>
            <div className="text-center">
              <p className="font-black italic tracking-widest text-lg">
                {searchTerm ? '查無匹配的異常紀錄' : '本日無重大事件'}
              </p>
              <p className="text-[10px] font-bold uppercase mt-2 tracking-[0.2em] text-slate-400">
                {searchTerm ? '請嘗試其他關鍵字' : 'System Healthy & Stable'}
              </p>
            </div>
          </div>
        )}
      </div>

      {/* 頁腳小提示 */}
      {hasEvents && filteredIncidents.length > 0 && (
        <div className="mt-4 text-right">
          <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">
            Showing {filteredIncidents.length} of {currentReport.majorIncidents.length} events
          </span>
        </div>
      )}
    </div>
  );
}
